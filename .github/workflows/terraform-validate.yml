# Fichier : .github/workflows/terraform-pipeline.yml
name: Terraform CI/CD Pipeline

on:
  push:
    branches:
      - main
      - staging
  pull_request:
    branches:
      - main
      - staging

permissions:
  id-token: write # n√©cessaire pour l‚Äôauthentification `OIDC` AWS
  contents: read # n√©cessaire pour `actions/checkout`
  pull-requests: write # n√©cessaire pour commenter les PR
  actions: read # n√©cessaire pour t√©l√©charger des artefacts
  deployments: write # n√©cessaire pour interagir avec les environnements GitHub

jobs:
  validate-code:
    name: Validate Terraform Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::148867357643:role/GitHubActions-Terraform-Role-Projet1 # !! remplacez par l‚ÄôARN de votre r√¥le !!
          aws-region: eu-west-3
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.12.1" # sp√©cifiez la version de `Terraform` √† utiliser
      - name: Terraform Init (validation mode)
        run: terraform init -backend=false -input=false
      - name: Terraform Format Check
        run: terraform fmt -check -recursive -diff
      - name: Terraform Validate
        run: terraform validate
      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: v0.58.0 # sp√©cifiez la version de `TFLint` √† utiliser
      - name: Init TFLint
        run: tflint --init
      - name: Run TFLint
        run: tflint --recursive --disable-rule=terraform_unused_declarations
      - name: Run Trivy IaC scan
        uses: aquasecurity/trivy-action@0.30.0
        with:
          scan-type: "config"
          input: "."
          format: "table"
          exit-code: "0" # ne pas √©chouer le job si des vuln√©rabilit√©s sont trouv√©es
          severity: "CRITICAL"
          ignore-unfixed: true

  terraform_plan:
    name: Generate Terraform Plan
    runs-on: ubuntu-latest
    needs: validate-code
    if: ${{ github.event_name == 'pull_request' }}
    outputs: # rendre le nom du fichier de plan binaire et le workspace disponibles
      plan_binary_filename: ${{ steps.plan.outputs.PLAN_BINARY_FILENAME }}
      tf_workspace: ${{ steps.set_workspace.outputs.tf_workspace }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::148867357643:role/GitHubActions-Terraform-Role-Projet1 # !! remplacez par l‚ÄôARN de votre r√¥le !!
          aws-region: eu-west-3
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.12.1" # sp√©cifiez la version de `Terraform` √† utiliser
      - name: Determine Terraform workspace
        id: set_workspace
        run: |
          # d√©terminer le workspace Terraform en fonction de la branche de base de la PR
          if [ "${{ github.base_ref }}" = "main" ]; then
            WORKSPACE=prod
          elif [ "${{ github.base_ref }}" = "staging" ]; then
            WORKSPACE=dev
          else
            WORKSPACE=dev
          fi
          echo "WORKSPACE=$WORKSPACE" >> $GITHUB_ENV
          echo "tf_workspace=$WORKSPACE" >> $GITHUB_OUTPUT
      - name: Terraform Init (for plan)
        id: init_plan
        run: terraform init -input=false
        # ici, nous initialisons le backend car le plan en a besoin pour lire l‚Äô√©tat actuel
      - name: Select Terraform workspace
        run: |
          echo "Selecting workspace : $WORKSPACE"
          terraform workspace select $WORKSPACE || terraform workspace new $WORKSPACE
      - name: Terraform Plan
        id: plan
        run: |
          PLAN_BINARY_FILENAME="tfplan-${WORKSPACE}.binary"
          PLAN_TEXT_FILENAME="tfplan-${WORKSPACE}.txt"
          echo "PLAN_BINARY_FILENAME=${PLAN_BINARY_FILENAME}" >> $GITHUB_OUTPUT # exporter le nom du fichier binaire

          echo "--- running terraform plan ---"
          terraform plan -input=false -no-color -out=$PLAN_BINARY_FILENAME -detailed-exitcode > $PLAN_TEXT_FILENAME
          PLAN_COMMAND_RAW_EXIT_CODE=$?
          echo "terraform plan command raw exit code : $PLAN_COMMAND_RAW_EXIT_CODE"

          echo "--- content of $PLAN_TEXT_FILENAME (first 50 lines) ---"
          head -n 50 $PLAN_TEXT_FILENAME
          echo "--- end of $PLAN_TEXT_FILENAME preview ---"

          FINAL_PLAN_DETAILS="v√©rification manuelle du plan requise (analyse du contenu ou code de sortie non concluant)." # valeur par d√©faut

          if [ "$PLAN_COMMAND_RAW_EXIT_CODE" -eq 1 ]; then
            FINAL_PLAN_DETAILS="‚ùå erreur critique lors de la g√©n√©ration du plan (terraform a retourn√© le code : $PLAN_COMMAND_RAW_EXIT_CODE)"
          elif grep -q -E "(No changes\. Infrastructure is up-to-date\.|No changes\. Your infrastructure matches the configuration\.|Plan: 0 to add, 0 to change, 0 to destroy\.)" $PLAN_TEXT_FILENAME; then
            FINAL_PLAN_DETAILS="‚úÖ aucun changement d√©tect√© (confirm√© par l‚Äôanalyse du contenu du plan)."
          elif PLAN_SUMMARY_LINE=$(grep -E "^Plan: ([0-9]+ to add, [0-9]+ to change, [0-9]+ to destroy\.)$" $PLAN_TEXT_FILENAME) && \
               (echo "$PLAN_SUMMARY_LINE" | grep -q -E "([1-9][0-9]* to add|[1-9][0-9]* to change|[1-9][0-9]* to destroy)"); then
            ADD=$(echo "$PLAN_SUMMARY_LINE" | sed -n 's/^Plan: \([0-9]*\) to add,.*/\1/p')
            CHANGE=$(echo "$PLAN_SUMMARY_LINE" | sed -n 's/^Plan: [0-9]* to add, \([0-9]*\) to change,.*/\1/p')
            DESTROY=$(echo "$PLAN_SUMMARY_LINE" | sed -n 's/^Plan:.*, \([0-9]*\) to destroy.$/\1/p')
            FINAL_PLAN_DETAILS="‚ö†Ô∏è changements d√©tect√©s (analyse du r√©sum√© : $ADD √† ajouter, $CHANGE √† modifier, $DESTROY √† d√©truire). voir l‚Äôart√©fact."
          else
            echo "warning : contenu du plan ambigu pour la d√©tection automatis√©e des changements. code de sortie brut de tf : $PLAN_COMMAND_RAW_EXIT_CODE."
            if [ "$PLAN_COMMAND_RAW_EXIT_CODE" -eq 0 ] || [ "$PLAN_COMMAND_RAW_EXIT_CODE" -eq 2 ]; then
              FINAL_PLAN_DETAILS="plan g√©n√©r√© (code tf : $PLAN_COMMAND_RAW_EXIT_CODE), mais contenu non analysable automatiquement. v√©rification manuelle requise."
            fi
          fi
          echo "PLAN_DETAILS=${FINAL_PLAN_DETAILS}" >> $GITHUB_OUTPUT
          echo "final PLAN_DETAILS set to : ${FINAL_PLAN_DETAILS}"

          if [ "$PLAN_COMMAND_RAW_EXIT_CODE" -eq 1 ]; then
            exit 1
          fi
        continue-on-error: true
      - name: Comment PR with plan output
        if: always()
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ### üìù r√©sultat du `terraform plan` pour le workspace `${{ steps.set_workspace.outputs.tf_workspace }}`
            ${{ steps.plan.outputs.PLAN_DETAILS }}
            le plan complet (`${{ steps.plan.outputs.plan_binary_filename }}.txt`) et le plan binaire (`${{ steps.plan.outputs.plan_binary_filename }}`) sont disponibles en tant qu‚Äôart√©facts.
            **veuillez examiner attentivement le plan avant d‚Äôapprouver cette PR.**
      - name: Upload Terraform Plan Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ steps.set_workspace.outputs.tf_workspace }}
          path: |
            tfplan-${{ steps.set_workspace.outputs.tf_workspace }}.binary
            tfplan-${{ steps.set_workspace.outputs.tf_workspace }}.txt
          retention-days: 7
          if-no-files-found: ignore